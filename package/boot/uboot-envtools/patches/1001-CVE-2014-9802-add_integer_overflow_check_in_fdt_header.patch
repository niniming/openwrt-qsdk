From 222e0ec9bc755bfeaa74f9a0052b7c709a4ad054 Mon Sep 17 00:00:00 2001
From: vijay kumar <vpendo@codeaurora.org>
Date: Tue, 12 Aug 2014 20:35:44 +0530
Subject: lib: fdt: add integer overflow checks in fdt header

these checks will usefull in finding the integer overflow
in fdt header fields.


CRs-Fixed: 705108
Change-Id: Ifc6f863cb54e34421bd9e69316eecf461e63ff5b
---
Index: u-boot-2014.10/lib/libfdt/fdt.c
===================================================================
--- u-boot-2014.10.orig/lib/libfdt/fdt.c
+++ u-boot-2014.10/lib/libfdt/fdt.c
@@ -30,6 +30,18 @@ int fdt_check_header(const void *fdt)
 		return -FDT_ERR_BADMAGIC;
 	}
 
+	if (fdt_off_dt_struct(fdt) > (UINT_MAX - fdt_size_dt_struct(fdt)))
+		return FDT_ERR_BADOFFSET;
+
+	if (fdt_off_dt_strings(fdt) > (UINT_MAX -  fdt_size_dt_strings(fdt)))
+		return FDT_ERR_BADOFFSET;
+
+	if ((fdt_off_dt_struct(fdt) + fdt_size_dt_struct(fdt)) > fdt_totalsize(fdt))
+		return FDT_ERR_BADOFFSET;
+
+	if ((fdt_off_dt_strings(fdt) + fdt_size_dt_strings(fdt)) > fdt_totalsize(fdt))
+		return FDT_ERR_BADOFFSET;
+
 	return 0;
 }
 
Index: u-boot-2014.10/lib/libfdt/fdt_rw.c
===================================================================
--- u-boot-2014.10.orig/lib/libfdt/fdt_rw.c
+++ u-boot-2014.10/lib/libfdt/fdt_rw.c
@@ -353,7 +353,7 @@ int fdt_del_node(void *fdt, int nodeoffs
 static void _fdt_packblocks(const char *old, char *new,
 			    int mem_rsv_size, int struct_size)
 {
-	int mem_rsv_off, struct_off, strings_off;
+	uint32_t mem_rsv_off, struct_off, strings_off;
 
 	mem_rsv_off = FDT_ALIGN(sizeof(struct fdt_header), 8);
 	struct_off = mem_rsv_off + mem_rsv_size;
